<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Admin V32 (Biblioteca Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; color: #333; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 1000; }
        .logo-area { padding: 20px; font-size: 1.5em; font-weight: bold; text-align: center; background: #1a252f; border-bottom: 1px solid #34495e; }
        .logo-area span { color: #2ecc71; }
        .menu { flex: 1; padding-top: 10px; overflow-y: auto; }
        .menu-label { padding: 10px 20px; font-size: 0.75em; text-transform: uppercase; color: #7f8c8d; font-weight: bold; margin-top: 10px; }
        .menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; color: #bdc3c7; text-decoration: none; }
        .menu-item:hover { background: #34495e; color: white; }
        .menu-item.active { background: #2980b9; color: white; border-left: 4px solid #3498db; }
        .menu-icon { width: 25px; text-align: center; margin-right: 10px; }

        /* HEADER MOBILE */
        .mobile-header { display: none; background: #2c3e50; color: white; padding: 15px; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; z-index: 999; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-hamburger { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; }

        /* CONTE√öDO */
        .content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .view-section { display: none; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }

        /* ESTILOS GERAIS */
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 0; color: #2c3e50; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e1e4e8; }
        .card-header { background: #f8f9fa; margin: -20px -20px 20px -20px; padding: 10px 20px; border-bottom: 1px solid #e1e4e8; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        input, select { padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; height: 38px; margin-bottom: 5px; }
        input[readonly] { background-color: #e9ecef; color: #6c757d; }
        label { font-size: 0.8em; font-weight: bold; color: #666; display: block; margin-bottom: 2px; }

        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; height: 38px; }
        button:hover { opacity: 0.9; }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; font-size: 0.8em; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #34495e; color: white; width: 100%; margin-top: 5px; }
        .btn-edit { background: #f39c12; color: white; font-size: 0.9em; padding: 5px 10px; height: auto; }
        .btn-trash { background: transparent; color: #c0392b; border: 1px solid #eccscs; font-size: 1.2em; padding: 5px 10px; height: auto; }
        .btn-activate { background: #8e44ad; color: white; width: 100%; padding: 15px; margin-top:10px; font-size: 1.1em; height: auto; }
        .btn-save-details { background: #27ae60; color: white; width: 100%; margin-top: 10px; }
        .btn-delete-event { background: #c0392b; color: white; width: 100%; padding: 15px; }
        .btn-purple { background: #9b59b6; color: white; }

        /* CATALOGO CLICK√ÅVEL */
        .catalog-item { 
            padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s;
        }
        .catalog-item:hover { background-color: #e8f4fd; padding-left: 15px; }
        .catalog-item b { color: #2c3e50; }

        /* Header Actions */
        .header-actions { display: flex; gap: 8px; }
        .cmd-btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        .btn-live { background: #8e44ad; } .btn-reset { background: #f1c40f; color: #333; } .btn-lock { background: #c0392b; } .btn-unlock { background: #27ae60; }

        /* GRIDS */
        .grid-3 { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-form-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .event-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #e8f4fd; padding: 15px; border-radius: 6px; margin-bottom: 15px; align-items: end; }
        .split-input { display: flex; gap: 5px; align-items: center; }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: white; padding: 25px; border-radius: 8px; width: 95%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 95vh; overflow-y: auto; }
        .close-modal { float: right; cursor: pointer; font-size: 1.5em; color: #999; }

        /* TABELAS */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; min-width: 600px; }
        th { background: #ecf0f1; color: #2c3e50; padding: 10px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        img.thumb { width: 35px; height: 35px; object-fit: cover; border-radius: 4px; }
        .input-table { border: 1px solid transparent; background: #f9f9f9; width: 100%; padding: 5px; height: 30px; }
        .input-table:focus { border: 1px solid #3498db; background: white; }

        /* COMPONENTES */
        .event-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .event-item.active { background: #e8f0fe; border-left: 4px solid #3498db; }
        .badge-live { background: #27ae60; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; margin-left: 5px; }
        .badge-closed { background: #7f8c8d; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; }
        
        .checkbox-container { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 0; border-radius: 4px; margin-bottom: 10px; }
        .chk-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .chk-item:hover { background: #f9f9f9; }
        .chk-item input { width: 18px; height: 18px; margin: 0 12px 0 0; }
        .chk-item.disabled { background-color: #f0f0f0; opacity: 0.6; pointer-events: none; }

        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border-bottom: 4px solid #ddd; }
        .kpi-val { font-size: 1.5em; font-weight: bold; color: #2c3e50; display: block; }
        .recipe-box { background: #f9f9f9; padding: 10px; border: 1px dashed #ccc; border-radius: 4px; }
        .danger-zone { margin-top: 30px; border-top: 2px dashed #e74c3c; padding-top: 20px; }
        .stock-tag { font-size: 0.7em; background: #eee; padding: 2px 6px; border-radius: 4px; color: #555; display: inline-block; margin-bottom: 2px; font-weight: bold; }

        @media (max-width: 900px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 280px; }
            .sidebar.active { transform: translateX(0); }
            .mobile-header { display: flex; }
            .content { padding: 80px 15px 20px 15px; }
            .grid-3, .grid-2, .event-details-grid, .time-grid, .grid-form-row, .kpi-grid { grid-template-columns: 1fr !important; }
            .sidebar-overlay.active { display: block; }
        }
    </style>
</head>
<body>

    <div class="mobile-header">
        <button class="btn-hamburger" onclick="toggleMenu()">‚ò∞</button>
        <span style="font-weight:bold; font-size:1.2em;">Aurora Admin</span>
        <span style="width:24px"></span>
    </div>
    <div class="sidebar-overlay" onclick="toggleMenu()"></div>

    <nav class="sidebar" id="mainSidebar">
        <div class="logo-area">üç∏ Aurora <span>Admin</span></div>
        <div class="menu">
            <div class="menu-label">Gest√£o Principal</div>
            <a onclick="showView('view-eventos', this)" class="menu-item active"><span class="menu-icon">üìÖ</span> Eventos</a>
            <a onclick="showView('view-equipe', this)" class="menu-item"><span class="menu-icon">üë•</span> Equipe</a>
            <div class="menu-label">Cadastros</div>
            <a onclick="showView('view-biblioteca', this)" class="menu-item"><span class="menu-icon">üçπ</span> Biblioteca & Ficha</a>
            <a onclick="showView('view-despensa', this)" class="menu-item"><span class="menu-icon">üì¶</span> Despensa</a>
            <div class="menu-label">Intelig√™ncia</div>
            <a onclick="showView('view-analytics', this)" class="menu-item"><span class="menu-icon">üìà</span> Estat√≠sticas</a>
        </div>
    </nav>

    <main class="content">
        <div id="view-eventos" class="view-section active">
            <h2>üìÖ Gest√£o de Eventos</h2>
            <div class="grid-3">
                <div class="card">
                    <h3>Meus Eventos</h3>
                    <button onclick="abrirModalNovo()" class="btn-primary" style="width:100%; margin-bottom:15px;">+ NOVO EVENTO</button>
                    <div id="lista-eventos" style="max-height:400px; overflow-y:auto;">Carregando...</div>
                </div>

                <div class="card" id="painel-detalhes" style="display:none;">
                    <div class="card-header">
                        <h3 id="titulo-evento" style="margin:0">Evento</h3>
                        <div class="header-actions">
                            <button onclick="ativarEvento()" class="cmd-btn btn-live">üöÄ ATIVAR NO APP</button>
                            <button onclick="reiniciarEvento()" class="cmd-btn btn-reset">üîÑ ZERAR</button>
                            <div id="controles-status"></div>
                        </div>
                    </div>

                    <div class="details-box" style="margin-top:15px; padding:15px; background:#f8f9fa; border:1px solid #ddd; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0;">üìù Dados do Evento</h4>
                        <div class="event-details-grid">
                            <div><label>Respons√°vel</label><input type="text" id="detResp"></div>
                            <div><label>Telefone</label><input type="text" id="detTel" onkeyup="mascaraTelefone(this)"></div>
                            <div><label>Data</label><input type="date" id="detData"></div>
                            <div><label>Local</label><input type="text" id="detLocal"></div>
                        </div>
                        <div class="time-grid">
                            <div><label>In√≠cio</label><input type="time" id="detHora" onchange="calcTermino('det')"></div>
                            <div><label>Dura√ß√£o</label><div class="split-input"><input type="number" id="detDurH" placeholder="H" value="4" onchange="calcTermino('det')"><span>:</span><input type="number" id="detDurM" placeholder="M" value="0" step="15" onchange="calcTermino('det')"></div></div>
                            <div><label>Extra</label><div class="split-input"><input type="number" id="detExtH" placeholder="H" value="0" onchange="calcTermino('det')" style="color:#2980b9;font-weight:bold"><span>:</span><input type="number" id="detExtM" placeholder="M" value="0" step="15" onchange="calcTermino('det')" style="color:#2980b9;font-weight:bold"></div></div>
                            <div><label>T√©rmino</label><input type="time" id="detTermino" readonly></div>
                        </div>
                        <button onclick="atualizarDadosEvento()" class="btn-save-details">üíæ Salvar Altera√ß√µes</button>
                    </div>

                    <div style="background:#eef2f7; padding:15px; border-radius:6px; margin:20px 0;">
                        <h4>üì• Montar Card√°pio</h4>
                        <div class="checkbox-container" id="lista-global-checkboxes"></div>
                        <div style="display:flex; justify-content:space-between; margin-top:10px;">
                            <button onclick="marcarTodos(true)" style="background:none; color:#3498db; text-decoration:underline;">Marcar Todos</button>
                            <button onclick="adicionarMuitos()" class="btn-primary">‚¨áÔ∏è Importar Selecionados</button>
                        </div>
                    </div>

                    <h4>üìã Card√°pio Confirmado</h4>
                    <div class="table-responsive">
                        <table><thead><tr><th width="40">Img</th><th>Nome</th><th>Venda</th><th>Custo</th><th>Est</th><th></th></tr></thead><tbody id="tabela-evento"></tbody></table>
                    </div>

                    <div class="danger-zone">
                        <h4 style="color:#c0392b; margin-top:0;">‚ö†Ô∏è Zona de Perigo</h4>
                        <button onclick="excluirEventoAtual()" class="btn-delete-event">üóëÔ∏è EXCLUIR EVENTO PERMANENTEMENTE</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-equipe" class="view-section">
            <h2>üë• Gest√£o de Equipe</h2>
            <div class="card">
                <div class="card-header">
                    <h3 style="margin:0; font-size:1.1em;">Equipe de Profissionais (Staff)</h3>
                    <button onclick="abrirModalEquipe()" class="btn-success">+ NOVO MEMBRO</button>
                </div>
                <div class="table-responsive" style="margin-top:15px;">
                    <table><thead><tr><th>Nome</th><th>Login (Celular)</th><th>Fun√ß√£o</th><th>Taxa</th><th>Adicional</th><th style="text-align:right">A√ß√µes</th></tr></thead><tbody id="lista-equipe"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-biblioteca" class="view-section">
            <h2>üçπ Biblioteca & Ficha</h2>
            <div class="grid-2">
                <div class="card">
                    <h3>Editor de Drinks</h3>
                    <input type="hidden" id="drinkId">
                    
                    <label>Nome do Drink</label><input type="text" id="globalName">
                    <label>Imagem (URL)</label><input type="text" id="globalImg" placeholder="./imagens/">
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <div style="flex:1"><label style="color:#27ae60">Pre√ßo Venda</label><input type="number" id="globalPrice" oninput="calcCMV()"></div>
                        <div style="flex:1"><label style="color:#e74c3c">Custo Prod.</label><input type="number" id="globalCusto" readonly></div>
                    </div>
                    <div id="cmv-display" style="text-align:center; font-weight:bold; color:#7f8c8d; margin:5px 0;">CMV: 0%</div>

                    <div class="recipe-box">
                        <h4>üìù Ficha T√©cnica (Ingredientes)</h4>
                        <div style="display:flex; gap:5px;">
                            <select id="selInsumo"><option>Carregando...</option></select>
                            <input type="number" id="qtdInsumo" placeholder="Qtd" style="width:60px;">
                            <button onclick="addIngrediente()" class="btn-purple">+</button>
                        </div>
                        <div id="lista-ingredientes" style="margin-top:10px; font-size:0.9em; max-height:100px; overflow-y:auto;"></div>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button onclick="limparFormDrink()" class="btn-info">Limpar / Novo</button>
                        <button onclick="salvarDrinkGlobal()" class="btn-warning" id="btnSalvarDrink">üíæ SALVAR</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Cat√°logo de Drinks</h3>
                    <p style="font-size:0.8em; color:#666;">Clique num drink para editar a ficha t√©cnica.</p>
                    <div id="lista-biblioteca-visual" style="max-height:500px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <div id="view-despensa" class="view-section">
            <h2>üì¶ Despensa & Insumos</h2>
            <div class="card">
                <h3>Cadastro de Produtos</h3>
                <div style="display:grid; gap:10px; background:#f9f9f9; padding:15px; border-radius:6px; border:1px solid #eee;">
                    <input type="hidden" id="insId">
                    <div class="grid-form-row">
                        <div><label>Produto</label><input type="text" id="insProd" placeholder="Ex: Gin"></div>
                        <div><label>Marca</label><input type="text" id="insMarca" placeholder="Ex: Tanqueray"></div>
                        <div><label>Tipo</label><select id="insTipo"><option>Destilado</option><option>Aperitivo</option><option>Bitter</option><option>Cocktail Alcoolico</option><option>Complemento</option><option>Frutas</option><option>Guarni√ß√£o</option><option>Guarni√ß√£o / Complemento</option><option>Mistura / Condimento</option><option>Soft drink</option><option>Sucos</option><option>Vinhos</option><option>Xarope</option></select></div>
                    </div>
                    <div class="grid-form-row">
                        <div><label>Un. Medida</label><select id="insUn"><option value="ml">ml</option><option value="kg">Kg</option><option value="g">g</option><option value="bj">bj</option></select></div>
                        <div><label>Qtde</label><input type="number" id="insQtde" placeholder="750"></div>
                        <div><label>Valor (R$)</label><input type="number" id="insValor" placeholder="120.00"></div>
                    </div>
                    <button onclick="salvarInsumo()" class="btn-success" style="width:100%; margin-top:15px;">üíæ Salvar no Estoque</button>
                </div>

                <h3 style="margin-top:20px;">Estoque Atual</h3>
                <div class="table-responsive">
                    <table><thead><tr><th>Tipo</th><th>Produto / Marca</th><th>Volume</th><th>Custo Total</th><th>Custo Unit.</th><th>A√ß√µes</th></tr></thead><tbody id="lista-insumos"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-analytics" class="view-section"><h2>üìà Analytics</h2><div class="card" style="display:flex; gap:10px;"><select id="select-evento-analise"><option>Carregando...</option></select><button onclick="gerarRelatorio()" class="btn-primary">Analisar</button></div><div class="kpi-grid" style="margin-top:20px;"><div class="kpi-card" style="border-color:gold"><small>Fat</small><span class="kpi-val" id="kpi-fat">0</span></div><div class="kpi-card" style="border-color:red"><small>Custo</small><span class="kpi-val" id="kpi-custo">0</span></div><div class="kpi-card" style="border-color:green"><small>Lucro</small><span class="kpi-val" id="kpi-lucro">0</span></div><div class="kpi-card" style="border-color:purple"><small>CMV</small><span class="kpi-val" id="kpi-cmv">0%</span></div></div><div class="grid-2" style="margin-top:20px;"><div class="card" style="height:300px"><canvas id="chartDrinks"></canvas></div><div class="card" style="height:300px"><canvas id="chartHorario"></canvas></div></div></div>
    </main>
	
	<div id="modalNovoEvento" class="modal-overlay"><div class="modal"><span class="close-modal" onclick="fecharModal()">√ó</span><h3>‚ú® Novo Evento</h3><div style="display:grid; gap: 10px;"><div><label>Nome</label><input type="text" id="mNome"></div><div><label>Respons√°vel</label><input type="text" id="mResp"></div><div><label>Telefone</label><input type="text" id="mTel" onkeyup="mascaraTelefone(this)"></div><div class="grid-2"><div><label>Data</label><input type="date" id="mData"></div><div><label>Local</label><input type="text" id="mLocal"></div></div><div class="time-grid"><div><label>In√≠cio</label><input type="time" id="mHora" onchange="calcTermino('m')"></div><div><label>Dur</label><div class="split-input"><input type="number" id="mDurH" value="4" onchange="calcTermino('m')">:<input type="number" id="mDurM" value="0" step="15" onchange="calcTermino('m')"></div></div><div><label>Ext</label><div class="split-input"><input type="number" id="mExtH" value="0" onchange="calcTermino('m')">:<input type="number" id="mExtM" value="0" step="15" onchange="calcTermino('m')"></div></div><div><label>Fim</label><input type="time" id="mTermino" readonly></div></div><button onclick="salvarNovoEvento()" class="btn-primary" style="margin-top:10px; padding:12px; width:100%">CRIAR</button></div></div></div>
    <div id="modalEquipe" class="modal-overlay"><div class="modal"><span class="close-modal" onclick="fecharModalEquipe()">√ó</span><h3 id="eqTitulo">üë§ Membro</h3><div style="display:grid; gap:10px"><input type="hidden" id="eqId"><div><label>Nome</label><input type="text" id="eqNome"></div><div class="grid-2"><div><label>Telefone</label><input type="text" id="eqTel" onkeyup="mascaraTelefone(this)"></div><div><label>CPF</label><input type="text" id="eqCPF" onkeyup="mascaraCPF(this)"></div></div><div class="grid-2"><div><label>Data Nasc</label><input type="date" id="eqData" onchange="calcIdade()"></div><div><label>Idade</label><input type="text" id="eqIdade" readonly></div></div><div class="grid-2"><select id="eqSexo"><option value="M">M</option><option value="F">F</option></select><select id="eqFuncao"><option>Bartender</option><option>Barback</option><option>Chefe de Bar</option><option>Gar√ßom</option><option>Copeiro</option><option>Gerente</option></select></div><div class="grid-2"><input type="number" id="eqTaxa" placeholder="Taxa"><input type="number" id="eqAdicional" placeholder="Add"></div><button onclick="salvarEquipe()" class="btn-success" style="margin-top:10px;padding:12px">SALVAR</button></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, query, orderBy, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚ö†Ô∏è COLE SUA CONFIG AQUI ‚ö†Ô∏è
	const firebaseConfig = {
	  apiKey: "AIzaSyBu8y9RQMv9fbxORcRLAZN4OlA1IEXyZUU",
	  authDomain: "aurora-bar-system.firebaseapp.com",
	  projectId: "aurora-bar-system",
	  storageBucket: "aurora-bar-system.firebasestorage.app",
	  messagingSenderId: "380441809814",
	  appId: "1:380441809814:web:ad008f37d30a5b0abe03b7"
	};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // UTILS
    window.toggleMenu = () => { document.getElementById('mainSidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').style.display = document.getElementById('mainSidebar').classList.contains('active') ? 'block' : 'none'; };
    window.showView = (id, el) => { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); if(window.innerWidth<=900)window.toggleMenu(); };
    window.mascaraTelefone = (i) => { let v=i.value.replace(/\D/g,"").replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d)(\d{4})$/,"$1-$2"); i.value=v; };
    window.mascaraCPF = (i) => { let v=i.value.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2"); i.value=v; };
    window.calcIdade = () => { const d=document.getElementById('eqData').value; if(d) document.getElementById('eqIdade').value = (new Date().getFullYear() - new Date(d).getFullYear()) + " anos"; };
    window.calcTermino = (p) => { const i=document.getElementById(p+'Hora').value, dH=parseInt(document.getElementById(p+'DurH').value)||0, dM=parseInt(document.getElementById(p+'DurM').value)||0, eH=parseInt(document.getElementById(p+'ExtH').value)||0, eM=parseInt(document.getElementById(p+'ExtM').value)||0; if(i){ const [h,m]=i.split(':').map(Number); let t=(h*60)+m+(dH*60)+dM+(eH*60)+eM; document.getElementById(p+'Termino').value=`${String(Math.floor(t/60)%24).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`; } };

    let eventoID=null, bibliotecaGlobal=[], insumosCache=[], receitaAtual=[], idsNoEvento=[], eventoAtivoID=null;

    // ============================================================
    // 1. DESPENSA & INSUMOS (L√ìGICA NOVA V31)
    // ============================================================
    onSnapshot(collection(db,"insumos"), (snap) => {
        insumosCache = [];
        const l = document.getElementById('lista-insumos');
        const s = document.getElementById('selInsumo');
        if(l) l.innerHTML=''; if(s) s.innerHTML='<option value="">Selecione...</option>';
        
        snap.forEach(doc => {
            const i = doc.data(); i.id = doc.id;
            // C√°lculo do Custo Unit√°rio (Pre√ßo / Quantidade)
            i.custoUnit = i.qtde > 0 ? (i.preco / i.qtde) : 0;
            insumosCache.push(i);
            
            const custoF = i.custoUnit < 0.01 ? i.custoUnit.toFixed(4) : i.custoUnit.toFixed(2);
            
            if(l) l.innerHTML += `
                <tr>
                    <td><span class="stock-tag">${i.tipo}</span></td>
                    <td><b>${i.produto}</b> <small>${i.marca}</small></td>
                    <td>${i.qtde} ${i.un_med}</td>
                    <td>R$ ${i.preco}</td>
                    <td style="color:#e74c3c">R$ ${custoF}/${i.un_med}</td>
                    <td>
                        <button onclick="editarInsumo('${i.id}', '${i.produto}', '${i.marca}', '${i.tipo}', '${i.un_med}', '${i.qtde}', '${i.preco}')" class="btn-edit" title="Editar">‚úèÔ∏è</button>
                        <button onclick="delInsumo('${i.id}')" class="btn-trash" title="Excluir">üóëÔ∏è</button>
                    </td>
                </tr>`;
            
            if(s) s.appendChild(new Option(`${i.produto} (${i.marca})`, i.id));
        });
    });

    window.salvarInsumo = async () => {
        const id = document.getElementById('insId').value;
        const d = {
            produto: document.getElementById('insProd').value,
            marca: document.getElementById('insMarca').value,
            tipo: document.getElementById('insTipo').value,
            un_med: document.getElementById('insUn').value,
            qtde: parseFloat(document.getElementById('insQtde').value),
            preco: parseFloat(document.getElementById('insValor').value)
        };

        if(!d.produto || !d.qtde || !d.preco) return alert("Preencha Produto, Quantidade e Valor!");

        try {
            if(id) {
                // MODO EDI√á√ÉO: Atualiza o existente
                await updateDoc(doc(db,"insumos",id), d);
                alert("Insumo atualizado!");
            } else {
                // MODO CRIA√á√ÉO: Checa duplicidade (Produto + Marca + Qtde)
                const q = query(collection(db,"insumos"), 
                    where("produto", "==", d.produto),
                    where("marca", "==", d.marca),
                    where("qtde", "==", d.qtde)
                );
                const check = await getDocs(q);
                if(!check.empty) return alert("Este produto j√° existe na despensa!");
                
                await addDoc(collection(db,"insumos"), d);
                alert("Salvo na Despensa!");
            }
            // Limpa
            document.getElementById('insId').value = '';
            ['insProd','insMarca','insQtde','insValor'].forEach(i=>document.getElementById(i).value='');
        } catch(e) { alert("Erro: " + e.message); }
    };

    window.editarInsumo = (id, prod, marca, tipo, un, qtde, valor) => {
        document.getElementById('insId').value = id;
        document.getElementById('insProd').value = prod;
        document.getElementById('insMarca').value = marca;
        document.getElementById('insTipo').value = tipo;
        document.getElementById('insUn').value = un;
        document.getElementById('insQtde').value = qtde;
        document.getElementById('insValor').value = valor;
        // Scroll para o topo
        document.querySelector('#view-despensa').scrollIntoView({behavior:'smooth'});
    };

    window.delInsumo = async(id) => {
        if(confirm("Tem certeza que deseja excluir este item da despensa?")) await deleteDoc(doc(db,"insumos",id));
    };


    // ============================================================
    // 2. BIBLIOTECA & FICHA T√âCNICA (L√ìGICA NOVA V31)
    // ============================================================
    
    // Carregar Lista de Drinks
    onSnapshot(collection(db,"drinks"), (s) => {
        bibliotecaGlobal = [];
        const l = document.getElementById('lista-biblioteca-visual');
        if(l) l.innerHTML = '';
        
        s.forEach(doc => {
            const d = doc.data();
            bibliotecaGlobal.push({...d, id: doc.id});
            
            // Item Clic√°vel para Edi√ß√£o
            if(l) l.innerHTML += `
                <div class="catalog-item" onclick="carregarDrinkParaEdicao('${doc.id}')">
                    <span><b>${d.nome}</b></span>
                    <div>
                        <span style="font-size:0.8em; color:#27ae60; margin-right:10px;">Venda: R$ ${d.precoVenda}</span>
                        <button onclick="excluirDrinkGlobal('${doc.id}', event)" class="btn-trash" style="font-size:0.9em; padding:2px 6px;">üóëÔ∏è</button>
                    </div>
                </div>`;
        });
        renderLib(); // Atualiza checkbox do evento tamb√©m
    });

    // Calculadora de Receita
    window.addIngrediente = () => {
        const id = document.getElementById('selInsumo').value;
        const qtd = parseFloat(document.getElementById('qtdInsumo').value);
        if(!id || !qtd) return;
        
        const i = insumosCache.find(x => x.id === id);
        // Calcula custo baseado na unidade do insumo
        const custoItem = i.custoUnit * qtd;

        receitaAtual.push({ 
            nome: `${i.produto} ${i.marca}`, 
            qtd: qtd, 
            un: i.un_med, 
            custo: custoItem,
            insumoId: id // Salva refer√™ncia
        });
        renderReceita();
    };

    function renderReceita() {
        let t = 0;
        document.getElementById('lista-ingredientes').innerHTML = receitaAtual.map((i, idx) => {
            t += i.custo;
            return `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #ccc; padding:4px; font-size:0.9em;">
                <span>${i.qtd}${i.un} ${i.nome}</span>
                <span>R$ ${i.custo.toFixed(2)} <a onclick="removerIngrediente(${idx})" style="color:red;cursor:pointer;margin-left:5px;">x</a></span>
            </div>`;
        }).join('');
        
        document.getElementById('globalCusto').value = t.toFixed(2);
        window.calcCMV();
    }

    window.removerIngrediente = (idx) => {
        receitaAtual.splice(idx, 1);
        renderReceita();
    };

    window.calcCMV = () => {
        const v = parseFloat(document.getElementById('globalPrice').value)||0;
        const c = parseFloat(document.getElementById('globalCusto').value)||0;
        if(v>0) {
            const cmv = ((c/v)*100).toFixed(1);
            const lucro = (v-c).toFixed(2);
            const cor = cmv > 35 ? '#e74c3c' : '#27ae60';
            document.getElementById('cmv-display').innerHTML = `CMV: <span style="color:${cor}">${cmv}%</span> | Lucro: R$ ${lucro}`;
        }
    };

    window.salvarDrinkGlobal = async () => {
        const id = document.getElementById('drinkId').value;
        const nome = document.getElementById('globalName').value;
        
        if(!nome) return alert("Nome √© obrigat√≥rio!");

        const dados = {
            nome: nome,
            imagem: document.getElementById('globalImg').value || "./imagens/",
            precoVenda: parseFloat(document.getElementById('globalPrice').value)||0,
            precoCusto: parseFloat(document.getElementById('globalCusto').value)||0,
            receita: receitaAtual,
            estoque: 0
        };

        try {
            if(id) {
                // ATUALIZAR
                await updateDoc(doc(db,"drinks",id), dados);
                alert("Drink Atualizado!");
            } else {
                // CRIAR NOVO (COM VERIFICA√á√ÉO DE NOME)
                const check = bibliotecaGlobal.find(d => d.nome.toLowerCase() === nome.toLowerCase());
                if(check) return alert("J√° existe um drink com este nome!");
                
                await addDoc(collection(db,"drinks"), dados);
                alert("Drink Criado!");
            }
            window.limparFormDrink();
        } catch(e) { alert(e.message); }
    };

    window.carregarDrinkParaEdicao = (id) => {
        const d = bibliotecaGlobal.find(x => x.id === id);
        if(d) {
            document.getElementById('drinkId').value = d.id;
            document.getElementById('globalName').value = d.nome;
            document.getElementById('globalImg').value = d.imagem;
            document.getElementById('globalPrice').value = d.precoVenda;
            document.getElementById('globalCusto').value = d.precoCusto;
            receitaAtual = d.receita || [];
            
            // Muda bot√£o para indicar edi√ß√£o
            document.getElementById('btnSalvarDrink').innerText = "üíæ ATUALIZAR";
            document.getElementById('btnSalvarDrink').classList.replace('btn-warning', 'btn-success');
            
            renderReceita();
            // Rola para o form
            document.querySelector('.grid-2').scrollIntoView({behavior:'smooth'});
        }
    };

    window.limparFormDrink = () => {
        document.getElementById('drinkId').value = '';
        ['globalName','globalImg','globalPrice','globalCusto'].forEach(i=>document.getElementById(i).value='');
        receitaAtual = [];
        renderReceita();
        document.getElementById('cmv-display').innerText = "CMV: 0%";
        document.getElementById('btnSalvarDrink').innerText = "üíæ SALVAR";
        document.getElementById('btnSalvarDrink').classList.replace('btn-success', 'btn-warning');
    };

    window.excluirDrinkGlobal = async (id, event) => {
        event.stopPropagation(); // Impede que o clique abra a edi√ß√£o
        if(confirm("Tem certeza que deseja excluir este drink da biblioteca?")) {
            await deleteDoc(doc(db,"drinks",id));
            window.limparFormDrink(); // Limpa se estava sendo editado
        }
    };


    // ============================================================
    // 3. EVENTOS & EQUIPE & ANALYTICS (MANTIDO V30)
    // ============================================================
    // (Esta parte do c√≥digo mant√©m tudo o que j√° funcionava: Eventos, Equipe, Analytics, etc.)
    
    onSnapshot(doc(db,"config","geral"), (s) => { if(s.exists()) { eventoAtivoID = s.data().eventoAtivoID; renderizarListaEventos(); }});
    let listaEventosCache=[]; onSnapshot(query(collection(db,"eventos"),orderBy("criadoEm","desc")),(snap)=>{listaEventosCache=[];snap.forEach(d=>listaEventosCache.push({...d.data(),id:d.id}));renderizarListaEventos();});
    function renderizarListaEventos() {
        const d=document.getElementById('lista-eventos'), sA=document.getElementById('select-evento-analise'); d.innerHTML=''; sA.innerHTML='<option value="">-- Escolha --</option>';
        listaEventosCache.forEach(ev=>{
            const item=document.createElement('div'); item.className=`event-item ${eventoID===ev.id?'active':''}`;
            const b=(ev.status==='fechado'?'<span class="badge-closed">FECHADO</span>':'')+(eventoAtivoID===ev.id?' <span class="badge-live">NO AR</span>':'');
            item.innerHTML=`<div><b>${ev.nome}</b><br><small>${new Date(ev.criadoEm?.toDate()).toLocaleDateString()}</small></div><div>${b}</div>`;
            item.onclick=()=>carregarEvento(ev.id,ev,ev.status||'aberto'); d.appendChild(item); sA.appendChild(new Option(ev.nome,ev.id));
        });
    }
    
    window.abrirModalNovo=()=>{document.getElementById('modalNovoEvento').style.display='flex';['mNome','mResp','mTel','mData','mHora','mLocal','mTermino'].forEach(i=>document.getElementById(i).value='');};
    window.fecharModal=()=>{document.getElementById('modalNovoEvento').style.display='none';};
    window.salvarNovoEvento=async()=>{const n=document.getElementById('mNome').value;if(!n)return alert("Nome!");const d={nome:n,responsavel:document.getElementById('mResp').value,telefone:document.getElementById('mTel').value,dataEvento:document.getElementById('mData').value,horaEvento:document.getElementById('mHora').value,durH:document.getElementById('mDurH').value,durM:document.getElementById('mDurM').value,extH:document.getElementById('mExtH').value,extM:document.getElementById('mExtM').value,termino:document.getElementById('mTermino').value,local:document.getElementById('mLocal').value,criadoEm:new Date(),status:'aberto'};try{const r=await addDoc(collection(db,"eventos"),d);fecharModal();carregarEvento(r.id,d,'aberto');}catch(e){alert(e.message);}};
    window.carregarEvento=(id,d,s)=>{eventoID=id;document.getElementById('painel-detalhes').style.display='block';document.getElementById('titulo-evento').innerText=d.nome;document.getElementById('detResp').value=d.responsavel||'';document.getElementById('detTel').value=d.telefone||'';document.getElementById('detData').value=d.dataEvento||'';document.getElementById('detHora').value=d.horaEvento||'';document.getElementById('detLocal').value=d.local||'';document.getElementById('detDurH').value=d.durH||'4';document.getElementById('detDurM').value=d.durM||'0';document.getElementById('detExtH').value=d.extH||'0';document.getElementById('detExtM').value=d.extM||'0';document.getElementById('detTermino').value=d.termino||'';onSnapshot(doc(db,"eventos",id),(sn)=>{if(sn.exists()){const st=sn.data().status||'aberto';document.getElementById('controles-status').innerHTML=st==='fechado'?`<button onclick="mudarStatus('aberto')" class="cmd-btn btn-unlock">üîì REABRIR</button>`:`<button onclick="mudarStatus('fechado')" class="cmd-btn btn-lock">üîí ENCERRAR</button>`;}});renderizarListaEventos();onSnapshot(collection(db,"eventos",id,"cardapio"),(snap)=>{const tb=document.getElementById('tabela-evento');tb.innerHTML='';idsNoEvento=[];snap.forEach(doc=>{const dd=doc.data();idsNoEvento.push(dd.idOriginal||doc.id);tb.innerHTML+=`<tr><td><img src="${dd.imagem||''}" class="thumb"></td><td>${dd.nome}</td><td><input type="number" value="${dd.precoVenda}" onchange="attItem('${doc.id}','precoVenda',this.value)" class="input-table" style="color:#27ae60"></td><td><input type="number" value="${dd.precoCusto}" onchange="attItem('${doc.id}','precoCusto',this.value)" class="input-table" style="color:#e74c3c"></td><td><input type="number" value="${dd.estoque}" onchange="attItem('${doc.id}','estoque',this.value)" class="input-table" style="width:50px"></td><td><button onclick="delItem('${doc.id}','${dd.nome}')" class="btn-trash">üóëÔ∏è</button></td></tr>`;});renderLib();});};
    window.atualizarDadosEvento=async()=>{if(eventoID)await updateDoc(doc(db,"eventos",eventoID),{responsavel:document.getElementById('detResp').value,telefone:document.getElementById('detTel').value,dataEvento:document.getElementById('detData').value,horaEvento:document.getElementById('detHora').value,durH:document.getElementById('detDurH').value,durM:document.getElementById('detDurM').value,extH:document.getElementById('detExtH').value,extM:document.getElementById('detExtM').value,termino:document.getElementById('detTermino').value,local:document.getElementById('detLocal').value});alert("Salvo!");};
    
    function renderLib(){const d=document.getElementById('lista-global-checkboxes');if(!d)return;d.innerHTML='';bibliotecaGlobal.sort((a,b)=>a.nome.localeCompare(b.nome));bibliotecaGlobal.forEach(x=>{const ja=idsNoEvento.includes(x.id);d.innerHTML+=`<div class="chk-item ${ja?'disabled':''}"><input type="checkbox" id="chk_${x.id}" value="${x.id}" class="chk-drink" ${ja?'disabled':''}><label for="chk_${x.id}"><b>${x.nome}</b> ${ja?'(Add)':''}</label></div>`;});}
    window.attItem=async(id,c,v)=>await updateDoc(doc(db,"eventos",eventoID,"cardapio",id),{[c]:parseFloat(v)});
    window.delItem=async(id,n)=>{if(confirm(`Remover ${n}?`))await deleteDoc(doc(db,"eventos",eventoID,"cardapio",id));};
    window.mudarStatus=async(s)=>await updateDoc(doc(db,"eventos",eventoID),{status:s});
    window.ativarEvento=async()=>{if(confirm("Ativar?"))await setDoc(doc(db,"config","geral"),{eventoAtivoID:eventoID,eventoAtivoNome:document.getElementById('titulo-evento').innerText},{merge:true});};
    window.reiniciarEvento=async()=>{if(confirm("ZERAR?")){const b=writeBatch(db);(await getDocs(collection(db,"eventos",eventoID,"vendas"))).forEach(d=>b.delete(d.ref));(await getDocs(collection(db,"eventos",eventoID,"cardapio"))).forEach(d=>b.update(d.ref,{estoque:50}));b.update(doc(db,"eventos",eventoID),{resetSignal:Date.now()});await b.commit();alert("Ok!");}};
    window.excluirEventoAtual=async()=>{if(confirm("Apagar?")){await deleteDoc(doc(db,"eventos",eventoID));location.reload();}};
    window.marcarTodos=(m)=>document.querySelectorAll('.chk-drink:not([disabled])').forEach(c=>c.checked=m);
    window.adicionarMuitos=async()=>{const c=document.querySelectorAll('.chk-drink:checked');if(!c.length)return;const b=writeBatch(db);c.forEach(chk=>{const d=bibliotecaGlobal.find(x=>x.id===chk.value);if(d)b.set(doc(collection(db,"eventos",eventoID,"cardapio")),{nome:d.nome,imagem:d.imagem,precoVenda:d.precoVenda||0,precoCusto:d.precoCusto||0,estoque:50,idOriginal:d.id});});await b.commit();document.querySelectorAll('.chk-drink').forEach(c=>c.checked=false);};

    // EQUIPE (MANTIDO)
    window.abrirModalEquipe=(id)=>{document.getElementById('modalEquipe').style.display='flex';document.getElementById('eqTitulo').innerText=id?'‚úèÔ∏è Editar':'üë§ Novo';document.getElementById('eqId').value=id||'';if(!id)['eqNome','eqTel','eqCPF','eqData','eqIdade','eqTaxa','eqAdicional'].forEach(i=>document.getElementById(i).value='');};
    window.fecharModalEquipe=()=>document.getElementById('modalEquipe').style.display='none';
    onSnapshot(collection(db,"equipe"),(s)=>{const l=document.getElementById('lista-equipe');l.innerHTML='';s.forEach(d=>{const b=d.data();l.innerHTML+=`<tr><td><b>${b.nome}</b><br><small style="color:#666">${b.funcao||''}</small></td><td>${b.telefone}</td><td>${b.funcao}</td><td>R$ ${parseFloat(b.taxa||0).toFixed(2)}</td><td>R$ ${parseFloat(b.adicional||0).toFixed(2)}</td><td style="text-align:right"><button onclick="editarEquipe('${d.id}','${b.nome}','${b.telefone}','${b.cpf}','${b.dataNasc}','${b.sexo}','${b.funcao}','${b.taxa}','${b.adicional}')" class="btn-edit">‚úèÔ∏è</button><button onclick="delEq('${d.id}')" class="btn-trash">üóëÔ∏è</button></td></tr>`;});});
    window.salvarEquipe=async()=>{const id=document.getElementById('eqId').value,tel=document.getElementById('eqTel').value;const d={nome:document.getElementById('eqNome').value,telefone:tel,cpf:document.getElementById('eqCPF').value,dataNasc:document.getElementById('eqData').value,sexo:document.getElementById('eqSexo').value,funcao:document.getElementById('eqFuncao').value,taxa:parseFloat(document.getElementById('eqTaxa').value)||0,adicional:parseFloat(document.getElementById('eqAdicional').value)||0};if(!d.nome||!d.telefone)return alert("Nome e Telefone!");if(!id){const q=query(collection(db,"equipe"),where("telefone","==",tel));const c=await getDocs(q);if(!c.empty)return alert("Telefone j√° existe!");await addDoc(collection(db,"equipe"),d);}else await updateDoc(doc(db,"equipe",id),d);fecharModalEquipe();};
    window.editarEquipe=(id,n,t,c,d,s,f,tx,ad)=>{window.abrirModalEquipe(id);document.getElementById('eqNome').value=n;document.getElementById('eqTel').value=t;document.getElementById('eqCPF').value=c;document.getElementById('eqData').value=d;document.getElementById('eqSexo').value=s;document.getElementById('eqFuncao').value=f;document.getElementById('eqTaxa').value=tx;document.getElementById('eqAdicional').value=ad;calcIdade();};
    window.delEq=async(id)=>await deleteDoc(doc(db,"equipe",id));

    // ANALYTICS
    window.gerarRelatorio=async()=>{const eid=document.getElementById('select-evento-analise').value;if(!eid)return;const s=await getDocs(collection(db,"eventos",eid,"vendas"));let fat=0,custo=0;const dc={},hc={};s.forEach(d=>{const v=d.data();fat+=parseFloat(v.preco||0);custo+=parseFloat(v.custo||0);dc[v.drink]=(dc[v.drink]||0)+1;const h=v.hora.toDate?v.hora.toDate().getHours()+":00":new Date(v.hora).getHours()+":00";hc[h]=(hc[h]||0)+1;});document.getElementById('kpi-fat').innerText='R$ '+fat.toFixed(2);document.getElementById('kpi-custo').innerText='R$ '+custo.toFixed(2);document.getElementById('kpi-lucro').innerText='R$ '+(fat-custo).toFixed(2);document.getElementById('kpi-cmv').innerText=fat>0?((custo/fat)*100).toFixed(1)+'%':'0%';const cD=document.getElementById('chartDrinks').getContext('2d');if(chartD)chartD.destroy();chartD=new Chart(cD,{type:'doughnut',data:{labels:Object.keys(dc),datasets:[{data:Object.values(dc),backgroundColor:['#e74c3c','#3498db','#f1c40f']}]},options:{responsive:true,maintainAspectRatio:false}});const cH=document.getElementById('chartHorario').getContext('2d');if(chartH)chartH.destroy();const sH=Object.keys(hc).sort((a,b)=>parseInt(a)-parseInt(b));chartH=new Chart(cH,{type:'line',data:{labels:sH,datasets:[{label:'Vendas',data:sH.map(h=>hc[h]),borderColor:'#3498db',fill:true}]},options:{responsive:true,maintainAspectRatio:false}});};
</script>
</body>
</html>