<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Aurora Admin V17 (Completo)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; color: #333; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- SIDEBAR (MENU LATERAL) --- */
        .sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease; z-index: 1000; }
        .logo-area { padding: 20px; font-size: 1.5em; font-weight: bold; text-align: center; background: #1a252f; border-bottom: 1px solid #34495e; }
        .logo-area span { color: #2ecc71; }
        
        .menu { flex: 1; padding-top: 10px; overflow-y: auto; }
        .menu-label { padding: 10px 20px; font-size: 0.75em; text-transform: uppercase; color: #7f8c8d; font-weight: bold; margin-top: 10px; }
        .menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; color: #bdc3c7; text-decoration: none; }
        .menu-item:hover { background: #34495e; color: white; }
        .menu-item.active { background: #2980b9; color: white; border-left: 4px solid #3498db; }
        .menu-icon { width: 25px; text-align: center; margin-right: 10px; }

        /* --- HEADER MOBILE --- */
        .mobile-header { display: none; background: #2c3e50; color: white; padding: 15px; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; z-index: 999; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-hamburger { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; }

        /* --- CONTE√öDO --- */
        .content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .view-section { display: none; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }

        /* --- ESTILOS GERAIS --- */
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 0; color: #2c3e50; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e1e4e8; }
        
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; font-size: 0.8em; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-activate { background: #8e44ad; color: white; width: 100%; padding: 15px; margin-top:10px; font-size: 1.1em; }
        .btn-save-details { background: #27ae60; color: white; width: 100%; margin-top: 10px; }
        .btn-purple { background: #9b59b6; color: white; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .close-modal { float: right; cursor: pointer; font-size: 1.5em; color: #999; }

        /* --- LAYOUTS --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .event-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }

        /* --- TABELAS RESPONSIVAS --- */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; min-width: 600px; }
        th { background: #ecf0f1; color: #2c3e50; padding: 10px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        img.thumb { width: 35px; height: 35px; object-fit: cover; border-radius: 4px; }
        
        .input-table { border: 1px solid transparent; background: #f9f9f9; width: 100%; padding: 5px; }
        .input-table:focus { border: 1px solid #3498db; background: white; }

        /* Componentes Espec√≠ficos */
        .event-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .event-item.active { background: #e8f0fe; border-left: 4px solid #3498db; }
        .badge-live { background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; }
        .badge-closed { background: #7f8c8d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; }
        
        .checkbox-container { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 0; border-radius: 4px; margin-bottom: 10px; }
        .chk-item { display: flex; align-items: center; padding: 8px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .chk-item:hover { background: #f9f9f9; }
        .chk-item input { width: 18px; height: 18px; margin: 0 12px 0 0; }
        .chk-item.disabled { background-color: #f0f0f0; opacity: 0.6; pointer-events: none; }

        .kpi-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border-bottom: 4px solid #ddd; }
        .kpi-val { font-size: 1.5em; font-weight: bold; color: #2c3e50; display: block; }
        .recipe-box { background: #f9f9f9; padding: 10px; border: 1px dashed #ccc; border-radius: 4px; }

        /* --- RESPONSIVIDADE MOBILE --- */
        @media (max-width: 900px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); width: 280px; }
            .sidebar.active { transform: translateX(0); }
            .mobile-header { display: flex; }
            .content { padding: 80px 15px 20px 15px; }
            .grid-3, .grid-2, .event-details-grid, .kpi-grid { grid-template-columns: 1fr !important; }
            .sidebar-overlay.active { display: block; }
        }
    </style>
</head>
<body>

    <div class="mobile-header">
        <button class="btn-hamburger" onclick="toggleMenu()">‚ò∞</button>
        <span style="font-weight:bold; font-size:1.2em;">Aurora Admin</span>
        <span style="width:24px"></span>
    </div>
    <div class="sidebar-overlay" onclick="toggleMenu()"></div>

    <nav class="sidebar" id="mainSidebar">
        <div class="logo-area">üç∏ Aurora <span>Admin</span></div>
        <div class="menu">
            <div class="menu-label">Gest√£o Principal</div>
            <a onclick="showView('view-eventos', this)" class="menu-item active"><span class="menu-icon">üìÖ</span> Eventos</a>
            <a onclick="showView('view-equipe', this)" class="menu-item"><span class="menu-icon">üë•</span> Equipe</a>
            
            <div class="menu-label">Gest√£o de Drinks</div>
            <a onclick="showView('view-biblioteca', this)" class="menu-item"><span class="menu-icon">üçπ</span> Biblioteca & Ficha</a>
            <a onclick="showView('view-despensa', this)" class="menu-item"><span class="menu-icon">üì¶</span> Despensa</a>
            
            <div class="menu-label">Intelig√™ncia</div>
            <a onclick="showView('view-analytics', this)" class="menu-item"><span class="menu-icon">üìà</span> Estat√≠sticas</a>
        </div>
    </nav>

    <main class="content">

        <div id="view-eventos" class="view-section active">
            <h2>üìÖ Gest√£o de Eventos</h2>
            <div class="grid-3">
                <div class="card">
                    <h3>Meus Eventos</h3>
                    <button onclick="abrirModalNovo()" class="btn-primary" style="width:100%; margin-bottom:15px;">+ NOVO EVENTO</button>
                    <div id="lista-eventos" style="max-height:400px; overflow-y:auto;">Carregando...</div>
                </div>

                <div class="card" id="painel-detalhes" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                        <h3 id="titulo-evento" style="margin:0">Evento</h3>
                        <div id="controles-status"></div>
                    </div>

                    <div class="details-box" style="margin-top:15px; background:#f8f9fa; padding:15px; border:1px solid #ddd; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0;">üìù Dados do Evento</h4>
                        <div class="event-details-grid">
                            <div><label>Respons√°vel</label><input type="text" id="detResp"></div>
                            <div><label>Telefone</label><input type="text" id="detTel" onkeyup="mascaraTelefone(this)"></div>
                            <div><label>Data</label><input type="date" id="detData"></div>
                            <div><label>Hor√°rio</label><input type="time" id="detHora"></div>
                        </div>
                        <div><label>Local</label><input type="text" id="detLocal"></div>
                        <button onclick="atualizarDadosEvento()" class="btn-save-details">üíæ Salvar Dados</button>
                    </div>

                    <div style="background:#eef2f7; padding:15px; border-radius:6px; margin:20px 0;">
                        <h4>üì• Montar Card√°pio</h4>
                        <div class="checkbox-container" id="lista-global-checkboxes"></div>
                        <div style="display:flex; justify-content:space-between; margin-top:10px;">
                            <button onclick="marcarTodos(true)" style="background:none; color:#3498db; text-decoration:underline;">Marcar Todos</button>
                            <button onclick="adicionarMuitos()" class="btn-primary">‚¨áÔ∏è Importar</button>
                        </div>
                    </div>

                    <h4>üìã Confirmados</h4>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th width="40">Img</th><th>Nome</th><th>Venda</th><th>Custo</th><th>Est</th><th></th></tr></thead>
                            <tbody id="tabela-evento"></tbody>
                        </table>
                    </div>

                    <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                        <button onclick="ativarEvento()" class="btn-activate">üöÄ ATIVAR NO APP</button>
                        <div style="display:flex; gap:10px;">
                            <button onclick="reiniciarEvento()" class="btn-warning" style="flex:1">üîÑ ZERAR</button>
                            <button onclick="excluirEventoAtual()" class="btn-danger" style="flex:1">üóëÔ∏è APAGAR</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-equipe" class="view-section">
            <h2>üë• Equipe</h2>
            <div class="card">
                <div style="display:grid; grid-template-columns: 2fr 1fr auto; gap:10px; margin-bottom:10px;">
                    <input type="text" id="bartenderNome" placeholder="Nome">
                    <input type="number" id="bartenderPhone" placeholder="Celular">
                    <button onclick="adicionarBartender()" class="btn-success">Add</button>
                </div>
                <div class="table-responsive">
                    <table><thead><tr><th>Nome</th><th>Login</th><th></th></tr></thead><tbody id="lista-equipe"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-biblioteca" class="view-section">
            <h2>üçπ Biblioteca & Ficha</h2>
            <div class="grid-2">
                <div class="card">
                    <h3>Novo Drink Global</h3>
                    <label>Nome</label><input type="text" id="globalName">
                    <label>Imagem</label><input type="text" id="globalImg" placeholder="./imagens/">
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <div style="flex:1"><label style="color:#27ae60">Venda</label><input type="number" id="globalPrice" oninput="calcCMV()"></div>
                        <div style="flex:1"><label style="color:#e74c3c">Custo</label><input type="number" id="globalCusto" readonly></div>
                    </div>
                    <div id="cmv-display" style="text-align:center; font-weight:bold; color:#7f8c8d; margin:5px 0;">CMV: 0%</div>

                    <div class="recipe-box">
                        <h4>üìù Ficha T√©cnica</h4>
                        <div style="display:flex; gap:5px;">
                            <select id="selInsumo"><option>Carregando...</option></select>
                            <input type="number" id="qtdInsumo" placeholder="Qtd" style="width:60px;">
                            <button onclick="addIngrediente()" class="btn-purple">+</button>
                        </div>
                        <div id="lista-ingredientes" style="margin-top:10px; font-size:0.9em;"></div>
                    </div>
                    <button onclick="adicionarAoGlobal()" class="btn-warning" style="width:100%; margin-top:15px;">Salvar na Biblioteca</button>
                </div>
                <div class="card">
                    <h3>Cat√°logo</h3>
                    <div id="lista-biblioteca-visual" style="max-height:400px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <div id="view-despensa" class="view-section">
            <h2>üì¶ Despensa (Insumos)</h2>
            <div class="grid-2">
                <div class="card">
                    <h3>Novo Insumo</h3>
                    <input type="text" id="insNome" placeholder="Nome (ex: Gin)">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="insPreco" placeholder="Pre√ßo Pago"><input type="number" id="insVol" placeholder="Volume Total">
                    </div>
                    <button onclick="salvarInsumo()" class="btn-primary" style="width:100%; margin-top:10px;">Guardar</button>
                </div>
                <div class="card"><h3>Estoque</h3><div id="lista-insumos" style="max-height:300px; overflow-y:auto;"></div></div>
            </div>
        </div>

        <div id="view-analytics" class="view-section">
            <h2>üìà Analytics</h2>
            <div class="card" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <select id="select-evento-analise" style="margin:0; min-width:200px;"><option>Carregando...</option></select>
                <button onclick="gerarRelatorio()" class="btn-primary">üîç Analisar</button>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card" style="border-color:#f1c40f"><small>Faturamento</small><span class="kpi-val" id="kpi-fat">R$ 0.00</span></div>
                <div class="kpi-card" style="border-color:#e74c3c"><small>Custo Prod.</small><span class="kpi-val" id="kpi-custo">R$ 0.00</span></div>
                <div class="kpi-card" style="border-color:#27ae60"><small>Lucro L√≠quido</small><span class="kpi-val" id="kpi-lucro">R$ 0.00</span></div>
                <div class="kpi-card" style="border-color:#8e44ad"><small>CMV Global</small><span class="kpi-val" id="kpi-cmv">0%</span></div>
            </div>
            <div class="grid-2">
                <div class="card" style="height:300px;"><canvas id="chartDrinks"></canvas></div>
                <div class="card" style="height:300px;"><canvas id="chartHorario"></canvas></div>
            </div>
        </div>

    </main>

    <div id="modalNovoEvento" class="modal-overlay">
        <div class="modal">
            <span class="close-modal" onclick="fecharModal()">√ó</span>
            <h3>‚ú® Novo Evento</h3>
            <div style="display:grid; gap: 10px;">
                <div><label>Nome</label><input type="text" id="mNome"></div>
                <div><label>Respons√°vel</label><input type="text" id="mResp"></div>
                <div><label>Telefone</label><input type="text" id="mTel" onkeyup="mascaraTelefone(this)"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Data</label><input type="date" id="mData"></div>
                    <div><label>Hor√°rio</label><input type="time" id="mHora"></div>
                </div>
                <div><label>Local</label><input type="text" id="mLocal"></div>
                <button onclick="salvarNovoEvento()" class="btn-primary" style="margin-top:10px; padding:12px;">CRIAR EVENTO</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, query, orderBy, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚ö†Ô∏è COLE SUA CONFIG AQUI ‚ö†Ô∏è
	const firebaseConfig = {
	  apiKey: "AIzaSyBu8y9RQMv9fbxORcRLAZN4OlA1IEXyZUU",
	  authDomain: "aurora-bar-system.firebaseapp.com",
	  projectId: "aurora-bar-system",
	  storageBucket: "aurora-bar-system.firebasestorage.app",
	  messagingSenderId: "380441809814",
	  appId: "1:380441809814:web:ad008f37d30a5b0abe03b7"
	};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- L√ìGICA DE MENU MOBILE ---
    window.toggleMenu = () => {
        document.getElementById('mainSidebar').classList.toggle('active');
        document.querySelector('.sidebar-overlay').style.display = 
            document.getElementById('mainSidebar').classList.contains('active') ? 'block' : 'none';
    };
    
    window.showView = (id, el) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(e=>e.classList.remove('active'));
        el.classList.add('active');
        if(window.innerWidth <= 900) window.toggleMenu();
    };

    // --- VARI√ÅVEIS DO SISTEMA ---
    let eventoID = null, bibliotecaGlobal = [], insumosCache = [], receitaAtual = [], chartD = null, chartH = null, idsNoEvento = [], eventoAtivoID = null;

    window.mascaraTelefone = (input) => { let v=input.value.replace(/\D/g,"").replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d)(\d{4})$/,"$1-$2"); input.value=v; };

    // ========================
    // 1. GEST√ÉO DE EVENTOS
    // ========================
    onSnapshot(query(collection(db, "eventos"), orderBy("criadoEm", "desc")), (snap) => {
        const div = document.getElementById('lista-eventos'); const selA = document.getElementById('select-evento-analise');
        div.innerHTML = ''; selA.innerHTML = '<option value="">-- Escolha --</option>';
        
        snap.forEach(d => {
            const ev = d.data();
            const item = document.createElement('div');
            item.className = `event-item ${eventoID === d.id ? 'active' : ''}`;
            const badges = (ev.status === 'fechado' ? '<span class="badge-closed">FECHADO</span>' : '') + (eventoAtivoID === d.id ? ' <span class="badge-live">NO AR</span>' : '');
            item.innerHTML = `<div><b>${ev.nome}</b><br><small>${new Date(ev.criadoEm?.toDate()).toLocaleDateString()}</small></div><div>${badges}</div>`;
            item.onclick = () => carregarEvento(d.id, ev, ev.status||'aberto');
            div.appendChild(item);
            const opt = document.createElement('option'); opt.value = d.id; opt.innerText = ev.nome; selA.appendChild(opt);
        });
    });

    window.abrirModalNovo=()=>{document.getElementById('modalNovoEvento').style.display='flex'; ['mNome','mResp','mTel','mData','mHora','mLocal'].forEach(i=>document.getElementById(i).value='');};
    window.fecharModal=()=>{document.getElementById('modalNovoEvento').style.display='none';};
    window.salvarNovoEvento=async()=>{
        const n=document.getElementById('mNome').value; if(!n)return alert("Nome!");
        const d={nome:n,responsavel:document.getElementById('mResp').value,telefone:document.getElementById('mTel').value,dataEvento:document.getElementById('mData').value,horaEvento:document.getElementById('mHora').value,local:document.getElementById('mLocal').value,criadoEm:new Date(),status:'aberto'};
        try{const r=await addDoc(collection(db,"eventos"),d); fecharModal(); carregarEvento(r.id,d,'aberto');}catch(e){alert(e.message);}
    };

    window.carregarEvento = (id, dados, status) => {
        eventoID = id; document.getElementById('painel-detalhes').style.display='block'; document.getElementById('titulo-evento').innerText=dados.nome;
        document.getElementById('detResp').value=dados.responsavel||''; document.getElementById('detTel').value=dados.telefone||''; document.getElementById('detData').value=dados.dataEvento||''; document.getElementById('detHora').value=dados.horaEvento||''; document.getElementById('detLocal').value=dados.local||'';
        document.getElementById('controles-status').innerHTML = status==='fechado'?`<button onclick="mudarStatus('aberto')" class="btn-success">üîì</button>`:`<button onclick="mudarStatus('fechado')" class="btn-danger">üõë</button>`;
        
        onSnapshot(collection(db,"eventos",id,"cardapio"), (snap) => {
            const tb = document.getElementById('tabela-evento'); tb.innerHTML=''; idsNoEvento=[];
            snap.forEach(doc => { const d=doc.data(); idsNoEvento.push(d.idOriginal||doc.id); tb.innerHTML+=`<tr><td><img src="${d.imagem||''}" class="thumb"></td><td>${d.nome}</td><td><input type="number" value="${d.precoVenda}" onchange="attItem('${doc.id}','precoVenda',this.value)" class="input-table" style="color:#27ae60"></td><td><input type="number" value="${d.precoCusto}" onchange="attItem('${doc.id}','precoCusto',this.value)" class="input-table" style="color:#e74c3c"></td><td><input type="number" value="${d.estoque}" onchange="attItem('${doc.id}','estoque',this.value)" class="input-table" style="width:50px"></td><td><button onclick="delItem('${doc.id}')" style="color:red;background:none">X</button></td></tr>`; });
            renderLib();
        });
    };

    window.atualizarDadosEvento=async()=>{if(eventoID)await updateDoc(doc(db,"eventos",eventoID),{responsavel:document.getElementById('detResp').value,telefone:document.getElementById('detTel').value,dataEvento:document.getElementById('detData').value,horaEvento:document.getElementById('detHora').value,local:document.getElementById('detLocal').value}); alert("Salvo!");};

    onSnapshot(doc(db,"config","geral"),(s)=>{if(s.exists())eventoAtivoID=s.data().eventoAtivoID;});
    
    // --- 2. BIBLIOTECA & INSUMOS ---
    onSnapshot(collection(db,"drinks"),(s)=>{
        bibliotecaGlobal=[]; const l=document.getElementById('lista-biblioteca-visual'); if(l)l.innerHTML='';
        s.forEach(doc=>{ const d=doc.data(); bibliotecaGlobal.push({...d,id:doc.id}); if(l)l.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee"><b>${d.nome}</b></div>`; });
        renderLib();
    });
    function renderLib(){
        const d=document.getElementById('lista-global-checkboxes'); if(!d)return; d.innerHTML='';
        bibliotecaGlobal.sort((a,b)=>a.nome.localeCompare(b.nome));
        bibliotecaGlobal.forEach(x=>{ const ja=idsNoEvento.includes(x.id); d.innerHTML+=`<div class="chk-item ${ja?'disabled':''}"><input type="checkbox" id="chk_${x.id}" value="${x.id}" class="chk-drink" ${ja?'disabled':''}><label for="chk_${x.id}"><b>${x.nome}</b> ${ja?'(Add)':''}</label></div>`; });
    }

    onSnapshot(collection(db,"insumos"),(s)=>{
        insumosCache = []; const l = document.getElementById('lista-insumos'); const sel = document.getElementById('selInsumo');
        if(l) l.innerHTML=''; if(sel) sel.innerHTML='<option value="">Selecione...</option>';
        s.forEach(doc => {
            const i = doc.data(); i.id=doc.id; i.custoUnit = i.preco/i.volume; insumosCache.push(i);
            if(l) l.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>${i.nome}</span><button onclick="delInsumo('${i.id}')" style="color:red;border:none;">x</button></div>`;
            if(sel) { const o=document.createElement('option'); o.value=i.id; o.innerText=i.nome; sel.appendChild(o); }
        });
    });

    window.addIngrediente = () => {
        const id = document.getElementById('selInsumo').value; const qtd = document.getElementById('qtdInsumo').value;
        if(!id) return;
        const i = insumosCache.find(x=>x.id===id);
        receitaAtual.push({nome:i.nome, custo:i.custoUnit*qtd, qtd:qtd});
        renderReceita();
    };
    function renderReceita(){
        let t=0; document.getElementById('lista-ingredientes').innerHTML = receitaAtual.map(i=>{t+=i.custo; return `<div>${i.qtd}x ${i.nome} (R$ ${i.custo.toFixed(2)})</div>`}).join('');
        document.getElementById('globalCusto').value = t.toFixed(2); window.calcCMV();
    }
    window.calcCMV = () => {
        const v = parseFloat(document.getElementById('globalPrice').value)||0; const c = parseFloat(document.getElementById('globalCusto').value)||0;
        if(v>0) document.getElementById('cmv-display').innerText = `CMV: ${((c/v)*100).toFixed(1)}% | Lucro: R$ ${(v-c).toFixed(2)}`;
    };
    
    window.adicionarAoGlobal = async () => {
        const n=document.getElementById('globalName').value;
        if(n) await addDoc(collection(db,"drinks"),{
            nome:n, imagem:document.getElementById('globalImg').value||"./imagens/",
            precoVenda:parseFloat(document.getElementById('globalPrice').value),
            precoCusto:parseFloat(document.getElementById('globalCusto').value),
            receita:receitaAtual, estoque:0
        });
        alert("Salvo!"); receitaAtual=[]; renderReceita();
    };

    window.salvarInsumo = async () => {
        const n=document.getElementById('insNome').value, p=document.getElementById('insPreco').value, v=document.getElementById('insVol').value;
        if(n) await addDoc(collection(db,"insumos"),{nome:n, preco:parseFloat(p), volume:parseFloat(v)});
    };
    window.delInsumo = async(id) => await deleteDoc(doc(db,"insumos",id));

    // --- A√á√ïES GERAIS ---
    window.attItem=async(id,c,v)=>await updateDoc(doc(db,"eventos",eventoID,"cardapio",id),{[c]:parseFloat(v)});
    window.delItem=async(id)=>await deleteDoc(doc(db,"eventos",eventoID,"cardapio",id));
    window.mudarStatus=async(s)=>await updateDoc(doc(db,"eventos",eventoID),{status:s});
    window.ativarEvento=async()=>{if(confirm("Ativar?"))await setDoc(doc(db,"config","geral"),{eventoAtivoID:eventoID,eventoAtivoNome:document.getElementById('titulo-evento').innerText},{merge:true});};
    window.reiniciarEvento=async()=>{if(confirm("ZERAR?")){const b=writeBatch(db);(await getDocs(collection(db,"eventos",eventoID,"vendas"))).forEach(d=>b.delete(d.ref));(await getDocs(collection(db,"eventos",eventoID,"cardapio"))).forEach(d=>b.update(d.ref,{estoque:50}));b.update(doc(db,"eventos",eventoID),{resetSignal:Date.now()});await b.commit();alert("Ok!");}};
    window.excluirEventoAtual=async()=>{if(confirm("Apagar?")){await deleteDoc(doc(db,"eventos",eventoID));location.reload();}};
    window.marcarTodos=(m)=>document.querySelectorAll('.chk-drink:not([disabled])').forEach(c=>c.checked=m);
    window.adicionarMuitos=async()=>{const c=document.querySelectorAll('.chk-drink:checked');if(!c.length)return;const b=writeBatch(db);c.forEach(chk=>{const d=bibliotecaGlobal.find(x=>x.id===chk.value);if(d)b.set(doc(collection(db,"eventos",eventoID,"cardapio")),{nome:d.nome,imagem:d.imagem,precoVenda:d.precoVenda||0,precoCusto:d.precoCusto||0,estoque:50,idOriginal:d.id});});await b.commit();document.querySelectorAll('.chk-drink').forEach(c=>c.checked=false);};

    // --- 3. EQUIPE ---
    onSnapshot(collection(db,"equipe"),(s)=>{const l=document.getElementById('lista-equipe');l.innerHTML='';s.forEach(d=>l.innerHTML+=`<tr><td>${d.data().nome}</td><td>${d.data().telefone}</td><td><button onclick="delEq('${d.id}')" style="color:red;border:none">x</button></td></tr>`)});
    window.adicionarBartender=async()=>{const n=document.getElementById('bartenderNome').value,t=document.getElementById('bartenderPhone').value;if(n)await addDoc(collection(db,"equipe"),{nome:n,telefone:t});};
    window.delEq=async(id)=>await deleteDoc(doc(db,"equipe",id));

    // --- 4. ANALYTICS ---
    window.gerarRelatorio=async()=>{
        const eid=document.getElementById('select-evento-analise').value;if(!eid)return;
        const s=await getDocs(collection(db,"eventos",eid,"vendas"));
        let fat=0,custo=0; const dc={},hc={};
        s.forEach(d=>{const v=d.data();fat+=parseFloat(v.preco||0);custo+=parseFloat(v.custo||0); dc[v.drink]=(dc[v.drink]||0)+1; const h=v.hora.toDate?v.hora.toDate().getHours()+":00":new Date(v.hora).getHours()+":00";hc[h]=(hc[h]||0)+1;});
        document.getElementById('kpi-fat').innerText='R$ '+fat.toFixed(2); document.getElementById('kpi-custo').innerText='R$ '+custo.toFixed(2); document.getElementById('kpi-lucro').innerText='R$ '+(fat-custo).toFixed(2); document.getElementById('kpi-cmv').innerText=fat>0?((custo/fat)*100).toFixed(1)+'%':'0%';
        const cD=document.getElementById('chartDrinks').getContext('2d'); if(chartD)chartD.destroy(); chartD=new Chart(cD,{type:'doughnut',data:{labels:Object.keys(dc),datasets:[{data:Object.values(dc),backgroundColor:['#e74c3c','#3498db','#f1c40f']}]},options:{responsive:true,maintainAspectRatio:false}});
        const cH=document.getElementById('chartHorario').getContext('2d'); if(chartH)chartH.destroy(); const sH=Object.keys(hc).sort((a,b)=>parseInt(a)-parseInt(b)); chartH=new Chart(cH,{type:'line',data:{labels:sH,datasets:[{label:'Vendas',data:sH.map(h=>hc[h]),borderColor:'#3498db',fill:true}]},options:{responsive:true,maintainAspectRatio:false}});
    };
</script>
</body>
</html>